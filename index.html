<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quantara — AI Betting Diary</title>

  <!-- Styles -->
  <link rel="stylesheet" href="styles.css" />

  <!-- Chart.js (v4) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Time scale date adapter (needed for x: { type: 'time' }) -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>

  <!-- Top bar: Brand + Auth -->
  <header class="topbar">
    <div class="brand">QUANTARA</div>
    <div class="auth">
      <!-- Auth inputs (stay in DOM always; app toggles visibility) -->
      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <button id="signup" class="btn">Sign up</button>
      <button id="signin" class="btn">Sign in</button>
      <button id="send-link" class="btn btn-ghost">Magic link</button>
      <!-- Legacy signout toggle (must exist) -->
      <button id="signout" class="btn btn-ghost" style="display:none;">Sign out</button>
      <!-- User menu gets injected here by app.js -->
    </div>
  </header>

  <!-- Tabs -->
  <nav class="tabs">
    <button id="tab-btn-home" class="tab active" onclick="__go('home')">Home</button>
    <button id="tab-btn-overview" class="tab" onclick="__go('overview')">Overview</button>
    <button id="tab-btn-analytics" class="tab" onclick="__go('analytics')">Analytics</button>
    <button id="tab-btn-roi" class="tab" onclick="__go('roi')">ROI</button>
    <button id="tab-btn-calendar" class="tab" onclick="__go('calendar')">Calendar</button>
    <button id="tab-btn-tools" class="tab" onclick="__go('tools')">Tools</button>
  </nav>

  <main class="container">

    <!-- ========== HOME ========== -->
    <section id="tab-home">
      <div class="row">
        <div class="col">
          <h2>Bankrolls</h2>
          <div class="subline">Current selection: <b id="current-bk">None selected</b></div>
        </div>
        <div class="col right">
          <button class="btn" onclick="__openBkModal()">New bankroll</button>
          <button class="btn btn-ghost" onclick="__clearActive()">Clear selection</button>
        </div>
      </div>

      <div id="bankroll-grid" class="grid bankroll-grid">
        <!-- bankroll cards rendered here -->
      </div>
    </section>

    <!-- New Bankroll Modal -->
    <div id="bk-modal" class="modal hidden">
      <div class="modal-card">
        <div class="modal-head">
          <h3>New bankroll</h3>
          <button id="bk-close" class="btn btn-ghost">✕</button>
        </div>
        <form id="bk-form" class="form">
          <label>Name
            <input id="bk-name" type="text" placeholder="e.g. Soccer 2025" required />
          </label>
          <label>Start amount
            <input id="bk-start" type="number" inputmode="decimal" step="0.01" placeholder="1000" />
          </label>
          <div class="row right">
            <button id="bk-cancel" type="button" class="btn btn-ghost">Cancel</button>
            <button type="submit" class="btn">Create</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ========== OVERVIEW ========== -->
    <section id="tab-overview" class="hidden">
      <h2>Overview — <span id="bk-name-inline">—</span></h2>

      <!-- KPIs -->
      <div class="grid kpi-grid">
        <div class="kpi">
          <div class="kpi-label">Bankroll</div>
          <div id="bankroll" class="kpi-value">€0</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Total staked</div>
          <div id="staked" class="kpi-value">€0</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Win rate</div>
          <div id="winrate" class="kpi-value">0%</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Start amount for <span id="bk-name-inline-2">—</span></div>
          <div class="row">
            <input id="bankroll-start" type="number" inputmode="decimal" step="0.01" />
            <button id="save-bankroll" class="btn">Save</button>
          </div>
        </div>
      </div>

      <!-- Bankroll chart -->
      <div class="panel">
        <div class="panel-head">
          <h3>Bankroll over time</h3>
        </div>
        <div class="chart-wrap">
          <canvas id="bankrollChart" height="140"></canvas>
        </div>
      </div>

      <!-- Add bet form -->
      <div class="panel">
        <div class="panel-head">
          <h3>Add bet</h3>
        </div>
        <form id="add-form" class="form grid form-grid">
          <label>Date
            <input id="f-date" type="date" />
          </label>
          <label>Sport
            <input id="f-sport" type="text" placeholder="Soccer" />
          </label>
          <label>League
            <input id="f-league" type="text" placeholder="Serie A" />
          </label>
          <label>Market
            <input id="f-market" type="text" placeholder="1X2" />
          </label>
          <label>Selection
            <input id="f-selection" type="text" placeholder="Inter" />
          </label>
          <label>Odds
            <input id="f-odds" type="number" step="0.01" inputmode="decimal" placeholder="1.90" />
          </label>
          <label>Stake
            <input id="f-stake" type="number" step="0.01" inputmode="decimal" placeholder="10" />
          </label>
          <label>Result
            <select id="f-result">
              <option value="pending">pending</option>
              <option value="win">win</option>
              <option value="loss">loss</option>
              <option value="void">void</option>
            </select>
          </label>
          <div class="row right full">
            <button class="btn" type="submit">Add</button>
          </div>
        </form>
      </div>

      <!-- Month filter tabs -->
      <div id="month-tabs" class="month-tabs">
        <!-- buttons rendered by JS -->
      </div>

      <!-- Ledger table -->
      <div class="table-wrap">
        <table id="ledger" class="table">
          <thead>
            <tr>
              <th>Date</th><th>Sport</th><th>League</th><th>Market</th><th>Selection</th>
              <th class="right">Odds</th><th class="right">Stake</th><th>Result</th><th class="right">P/L</th><th class="right">Actions</th>
            </tr>
          </thead>
          <tbody><!-- rows --></tbody>
        </table>
      </div>
    </section>

    <!-- Edit Bet Modal -->
    <div id="edit-modal" class="modal hidden">
      <div class="modal-card">
        <div class="modal-head">
          <h3>Edit bet</h3>
          <button id="edit-close" class="btn btn-ghost">✕</button>
        </div>
        <form id="edit-form" class="form grid form-grid">
          <input id="e-id" type="hidden" />
          <label>Date
            <input id="e-date" type="date" />
          </label>
          <label>Sport
            <input id="e-sport" type="text" />
          </label>
          <label>League
            <input id="e-league" type="text" />
          </label>
          <label>Market
            <input id="e-market" type="text" />
          </label>
          <label>Selection
            <input id="e-selection" type="text" />
          </label>
          <label>Odds
            <input id="e-odds" type="number" step="0.01" inputmode="decimal" />
          </label>
          <label>Stake
            <input id="e-stake" type="number" step="0.01" inputmode="decimal" />
          </label>
          <label>Result
            <select id="e-result">
              <option value="pending">pending</option>
              <option value="win">win</option>
              <option value="loss">loss</option>
              <option value="void">void</option>
            </select>
          </label>
          <div class="row right full">
            <button id="edit-cancel" type="button" class="btn btn-ghost">Cancel</button>
            <button type="submit" class="btn">Save</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ========== ANALYTICS ========== -->
    <section id="tab-analytics" class="hidden">
      <h2>Analytics — <span id="bk-name-inline-2">—</span></h2>

      <div class="grid kpi-grid">
        <div class="kpi"><div class="kpi-label">Net profit</div><div id="an-net-profit" class="kpi-value">€0</div></div>
        <div class="kpi"><div class="kpi-label">Total staked</div><div id="an-staked" class="kpi-value">€0</div></div>
        <div class="kpi"><div class="kpi-label">Avg stake</div><div id="avg-stake" class="kpi-value">€0</div></div>
        <div class="kpi"><div class="kpi-label">Avg odds</div><div id="avg-odds" class="kpi-value">0.00</div></div>
        <div class="kpi"><div class="kpi-label">Win rate</div><div id="an-winrate" class="kpi-value">0%</div></div>
        <div class="kpi"><div class="kpi-label">Profit factor</div><div id="an-pf" class="kpi-value">0.00</div></div>
        <div class="kpi"><div class="kpi-label">Max drawdown</div><div id="max-dd" class="kpi-value">€0</div></div>
        <div class="kpi"><div class="kpi-label">Edge / Kelly%</div><div id="edge" class="kpi-value">0.00% / 0.00%</div></div>
      </div>

      <div class="grid chart-grid">
        <div class="panel"><h3>P/L by sport</h3><div class="chart-wrap"><canvas id="pnlBySportChart" height="160"></canvas></div></div>
        <div class="panel"><h3>Win rate by sport</h3><div class="chart-wrap"><canvas id="winRateBySportChart" height="160"></canvas></div></div>
        <div class="panel"><h3>P/L by month</h3><div class="chart-wrap"><canvas id="pnlMonthChart" height="160"></canvas></div></div>
        <div class="panel"><h3>P/L by weekday</h3><div class="chart-wrap"><canvas id="weekdayChart" height="160"></canvas></div></div>
        <div class="panel"><h3>Odds histogram</h3><div class="chart-wrap"><canvas id="oddsHistChart" height="160"></canvas></div></div>
        <div class="panel"><h3>Results breakdown</h3><div class="chart-wrap"><canvas id="resultsPieChart" height="160"></canvas></div></div>
      </div>
    </section>

    <!-- ========== ROI ========== -->
    <section id="tab-roi" class="hidden">
      <h2>ROI</h2>
      <div class="grid kpi-grid">
        <div class="kpi"><div class="kpi-label">Overall ROI</div><div id="roi-overall" class="kpi-value">0%</div></div>
        <div class="kpi"><div class="kpi-label">Settled bets</div><div id="roi-settled" class="kpi-value">0</div></div>
        <div class="kpi"><div class="kpi-label">Profit</div><div id="roi-profit" class="kpi-value">€0</div></div>
        <div class="kpi"><div class="kpi-label">Stake</div><div id="roi-stake" class="kpi-value">€0</div></div>
      </div>

      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr><th>Sport</th><th class="right">Bets</th><th class="right">Stake</th><th class="right">Profit</th><th class="right">ROI</th></tr>
          </thead>
          <tbody id="roi-tbody"><!-- rows --></tbody>
        </table>
      </div>
    </section>

    <!-- ========== CALENDAR ========== -->
    <section id="tab-calendar" class="hidden">
      <div class="row">
        <h2>Calendar</h2>
        <div class="spacer"></div>
        <button id="cal-prev" class="btn btn-ghost">◀</button>
        <div id="cal-title" class="pill">—</div>
        <button id="cal-next" class="btn btn-ghost">▶</button>
      </div>

      <div id="calendar-grid" class="calendar-grid"><!-- days --></div>

      <div class="panel">
        <div class="row">
          <h3>Day details</h3>
          <div class="spacer"></div>
          <button id="clear-filter" class="btn btn-ghost">Clear</button>
        </div>
        <div class="row">
          <div class="muted">Selected:</div>
          <div id="day-selected" class="pill">—</div>
          <div class="muted">PnL:</div>
          <div id="day-pnl" class="pill">€0</div>
        </div>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr><th>Sport</th><th>Market</th><th>Selection</th><th class="right">Odds</th><th class="right">Stake</th><th class="right">Result</th><th class="right">P/L</th></tr>
            </thead>
            <tbody id="day-tbody"><!-- rows --></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ========== TOOLS ========== -->
    <section id="tab-tools" class="hidden">
      <h2>Tools</h2>

      <div class="tools-nav">
        <span id="tool-btn-risk" class="chip active">Risk</span>
        <span id="tool-btn-poisson" class="chip">Poisson</span>
        <span id="tool-btn-masa" class="chip">Masaniello</span>
      </div>

      <!-- Risk -->
      <div id="tools-risk">
        <div class="grid form-grid">
          <label>Bankroll
            <input id="rk-bankroll" type="number" step="0.01" inputmode="decimal" placeholder="1000" />
          </label>
          <label>Odds
            <input id="rk-odds" type="number" step="0.01" inputmode="decimal" placeholder="1.90" />
          </label>
          <label>Win probability (%)
            <input id="rk-prob" type="number" step="0.1" inputmode="decimal" placeholder="55" />
            <input id="rk-prob-range" type="range" min="0" max="100" step="0.1" />
          </label>
          <label>Cap stake (% of BR)
            <input id="rk-cap" type="number" step="0.1" inputmode="decimal" placeholder="2.5" />
            <input id="rk-cap-range" type="range" min="0" max="100" step="0.1" />
          </label>
          <div class="row right full">
            <button id="rk-run" class="btn">Run</button>
          </div>
        </div>

        <div class="grid kpi-grid">
          <div class="kpi"><div class="kpi-label">Break-even</div><div id="rk-be" class="kpi-value">0%</div></div>
          <div class="kpi"><div class="kpi-label">Edge</div><div id="rk-edge" class="kpi-value">0%</div></div>
          <div class="kpi"><div class="kpi-label">EV per €1</div><div id="rk-ev" class="kpi-value">€0</div></div>
          <div class="kpi"><div class="kpi-label">Kelly%</div><div id="rk-kelly" class="kpi-value">0%</div></div>
        </div>

        <div class="panel">
          <h3>Stake sizing</h3>
          <div class="chart-wrap"><canvas id="rkStakeChart" height="160"></canvas></div>
        </div>
      </div>

      <!-- Poisson -->
      <div id="tools-poisson" class="hidden">
        <div class="grid form-grid">
          <label>Home λ (avg goals)
            <input id="ps-home" type="number" step="0.01" inputmode="decimal" placeholder="1.40" />
          </label>
          <label>Away λ (avg goals)
            <input id="ps-away" type="number" step="0.01" inputmode="decimal" placeholder="1.10" />
          </label>
          <label>O/U line
            <input id="ps-ouline" type="number" step="0.5" inputmode="decimal" placeholder="2.5" />
          </label>
          <div class="row right full">
            <button id="ps-run" class="btn">Run</button>
          </div>
        </div>

        <div class="grid kpi-grid">
          <div class="kpi"><div class="kpi-label">Home win</div><div id="ps-ph" class="kpi-value">0%</div></div>
          <div class="kpi"><div class="kpi-label">Draw</div><div id="ps-pd" class="kpi-value">0%</div></div>
          <div class="kpi"><div class="kpi-label">Away win</div><div id="ps-pa" class="kpi-value">0%</div></div>
          <div class="kpi"><div class="kpi-label">Over</div><div id="ps-over" class="kpi-value">0%</div></div>
          <div class="kpi"><div class="kpi-label">BTTS Yes</div><div id="ps-btts" class="kpi-value">0%</div></div>
        </div>

        <div class="grid chart-grid">
          <div class="panel"><h3>1X2 probabilities</h3><div class="chart-wrap"><canvas id="ps1x2Chart" height="160"></canvas></div></div>
          <div class="panel"><h3>Total goals distribution</h3><div class="chart-wrap"><canvas id="psGoalsChart" height="160"></canvas></div></div>
          <div class="panel"><h3>BTTS</h3><div class="chart-wrap"><canvas id="psBttsChart" height="160"></canvas></div></div>
        </div>

        <div class="table-wrap">
          <table class="table">
            <thead><tr><th>Market</th><th class="right">Prob</th><th class="right">Fair odds</th></tr></thead>
            <tbody id="ps-table"><!-- rows --></tbody>
          </table>
        </div>
      </div>

      <!-- Masaniello -->
      <div id="tools-masa" class="hidden">
        <div class="grid form-grid">
          <label>Name
            <input id="ms-name" type="text" placeholder="My System" />
          </label>
          <label>Capital
            <input id="ms-capital" type="number" step="0.01" inputmode="decimal" placeholder="500" />
          </label>
          <label>Target profit
            <input id="ms-target" type="number" step="0.01" inputmode="decimal" placeholder="50" />
          </label>
          <label>Odds
            <input id="ms-odds" type="number" step="0.01" inputmode="decimal" placeholder="1.80" />
          </label>
          <label># Bets
            <input id="ms-n" type="number" inputmode="numeric" placeholder="10" />
          </label>
          <label>Win prob (%)
            <input id="ms-p" type="number" step="0.1" inputmode="decimal" placeholder="55" />
            <input id="ms-p-range" type="range" min="0" max="100" step="0.1" />
          </label>
          <label>Wins done
            <input id="ms-wins" type="number" inputmode="numeric" placeholder="0" />
          </label>
          <div class="row right full">
            <button id="ms-run" class="btn">Run</button>
            <select id="ms-load" class="btn btn-ghost"><option>Load saved…</option></select>
            <button id="ms-save" class="btn btn-ghost">Save</button>
            <button id="ms-delete" class="btn btn-ghost">Delete saved</button>
          </div>
        </div>

        <div class="grid kpi-grid">
          <div class="kpi"><div class="kpi-label">Est. wins (q)</div><div id="ms-q" class="kpi-value">0</div></div>
          <div class="kpi"><div class="kpi-label">Remaining</div><div id="ms-rem" class="kpi-value">0</div></div>
          <div class="kpi"><div class="kpi-label">Next stake</div><div id="ms-stake" class="kpi-value">€0</div></div>
          <div class="kpi"><div class="kpi-label">If WIN</div><div id="ms-nextwin" class="kpi-value">€0</div></div>
          <div class="kpi"><div class="kpi-label">If LOSS</div><div id="ms-nextloss" class="kpi-value">€0</div></div>
        </div>

        <div class="table-wrap">
          <table class="table">
            <thead><tr><th>#</th><th class="right">Stake</th><th class="right">Result</th><th class="right">Capital</th><th class="right">Apply</th></tr></thead>
            <tbody id="ms-rows"><!-- rows --></tbody>
          </table>
        </div>
      </div>
    </section>

  </main>

  <!-- App (must be a module because app.js imports Supabase) -->
  <script type="module" src="app.js"></script>
</body>
</html>
