<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QUANTARA — AI Betting Diary</title>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

<!-- Favicon (inline to avoid 404s) -->
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='14' fill='%237c3aed'/%3E%3C/svg%3E">

<!-- Styles (inline) -->
<style>
:root{
  --bg:#080d16; --panel:#0d1524; --border:#1b2740;
  --text:#e7eefc; --muted:#93a0b7;
  --accent:#7c3aed; --accent2:#22d3ee;
  --success:#22c55e; --danger:#ef4444;
  --card-glass: rgba(255,255,255,0.04);
}
*{ box-sizing:border-box; }
html,body{ height:100%; }
body{ margin:0; font-family:"Outfit",system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
.hidden{ display:none; }

/* Background */
.bg{ position:fixed; inset:0; pointer-events:none; }
.bg-glow{ position:absolute; width:60vmax; height:60vmax; border-radius:50%; left:50%; top:-10vmax; transform:translateX(-50%); background:radial-gradient(closest-side, rgba(124,58,237,0.25), transparent 65%); filter:blur(40px); }
.bg-grid{ position:absolute; inset:0; background-image:linear-gradient(to right, rgba(255,255,255,0.05) 1px, transparent 1px),linear-gradient(to bottom, rgba(255,255,255,0.05) 1px, transparent 1px); background-size:36px 36px; mask-image:radial-gradient(circle at 50% 0%, black 35%, transparent 80%); opacity:.35; }

/* Topbar */
.topbar{ position:sticky; top:0; z-index:10; display:flex; justify-content:space-between; align-items:center; padding:14px 20px; background:rgba(8,13,22,0.7); backdrop-filter: blur(12px); border-bottom:1px solid var(--border); }
.brand{ display:flex; align-items:center; gap:10px; }
.logo-dot{ width:12px; height:12px; border-radius:50%; background:linear-gradient(135deg,var(--accent),var(--accent2)); box-shadow:0 0 18px var(--accent); }
.brand-text{ display:flex; flex-direction:column; line-height:1; }
.brand-name{ font-weight:700; letter-spacing:1px; } .brand-tag{ font-size:12px; color:var(--muted); }
.auth{ display:flex; gap:8px; align-items:center; }
.auth input{ background:var(--panel); border:1px solid var(--border); color:var(--text); padding:8px 10px; border-radius:10px; outline:none; min-width:190px; }
.btn{ border:1px solid var(--border); background:var(--card-glass); color:var(--text); padding:8px 12px; border-radius:12px; cursor:pointer; transition: all .2s ease; }
.btn:hover{ border-color:var(--accent2); box-shadow:0 0 0 2px rgba(34,211,238,0.2) inset; }
.btn-primary{ background:linear-gradient(135deg,var(--accent),var(--accent2)); border:none; color:#08111f; font-weight:600; }
.btn-ghost{ background:transparent; }
.btn.small{ padding:6px 10px; font-size:12px; }

.container{ max-width:1150px; margin:24px auto; padding:0 16px; }

/* Tabs */
.tabs{ display:flex; gap:8px; margin-bottom:12px; position:relative; z-index:2; }
.tab{ background:var(--card-glass); border:1px solid var(--border); padding:8px 12px; border-radius:10px; cursor:pointer; color:var(--muted); }
.tab.active{ color:var(--text); border-color:var(--accent2); box-shadow:0 0 0 2px rgba(34,211,238,0.15) inset; }

/* Cards */
.cards{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; }
.card{ background:var(--card-glass); border:1px solid var(--border); border-radius:16px; padding:14px 16px; backdrop-filter:blur(8px); }
.card-label{ color:var(--muted); font-size:13px; } .card-value{ font-size:28px; font-weight:700; margin-top:4px; }
.card.settings .settings-row{ display:flex; gap:8px; margin-top:6px; }
.card.settings input{ background:var(--panel); border:1px solid var(--border); color:var(--text); padding:8px 10px; border-radius:10px; width:160px; }
.muted{ color:var(--muted); } .small{ font-size:12px; }

/* Charts */
.charts{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:16px; }
.chart-card{ background:var(--card-glass); border:1px solid var(--border); border-radius:16px; padding:12px; }
.chart-title{ color:var(--muted); font-size:13px; margin-bottom:6px; }

/* Analytics */
.analytics-charts{ display:grid; gap:12px; margin-top:16px; grid-template-columns:1fr 1fr; }
.analytics-charts .span-2{ grid-column: span 2; }
.donut-wrap-lg{ width:420px; height:420px; margin:6px auto 2px; position:relative; }

/* Add form */
.entry{ margin-top:16px; }
.add-form{ background:var(--card-glass); border:1px solid var(--border); border-radius:16px; padding:12px; display:grid; gap:8px; grid-template-columns: repeat(5,1fr) 120px 120px 120px; }
.add-form .form-title{ grid-column:1/-1; font-weight:600; color:var(--muted); }
.add-form input, .add-form select{ background:var(--panel); border:1px solid var(--border); color:var(--text); padding:8px 10px; border-radius:10px; outline:none; }
.add-form button{ grid-column:-2/-1; }

/* Ledger month tabs */
.ledger-section{ margin-top:16px; }
.month-tabs{ display:flex; gap:8px; overflow-x:auto; padding:6px 0 10px; margin-top:6px; }
.month-tab{
  display:flex; align-items:center; gap:8px;
  background:var(--card-glass); border:1px solid var(--border); color:var(--muted);
  padding:6px 12px; border-radius:999px; cursor:pointer; white-space:nowrap;
}
.month-tab:hover{ border-color:var(--accent2); }
.month-tab.active{ color:var(--text); border-color:var(--accent2); box-shadow:0 0 0 2px rgba(34,211,238,0.12) inset; }
.month-pill{ padding:2px 8px; border-radius:999px; font-size:12px; background:rgba(255,255,255,0.06); border:1px solid var(--border); }
.month-pill.pos{ color:var(--success); } .month-pill.neg{ color:var(--danger); }

/* Calendar */
.calendar{ background:var(--card-glass); border:1px solid var(--border); border-radius:16px; padding:12px; }
.calendar-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.calendar-title{ font-weight:600; }
.calendar-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
.calendar-grid .cell{ position:relative; aspect-ratio:1; display:flex; align-items:flex-start; justify-content:flex-start; padding:6px; border:1px solid var(--border); border-radius:10px; font-size:13px; color:var(--muted); background:var(--panel); cursor:pointer; transition: border-color .15s, box-shadow .15s; }
.calendar-grid .cell:hover{ border-color:var(--accent2); box-shadow:0 0 0 2px rgba(34,211,238,0.12) inset; }
.calendar-grid .cell.out{ opacity:.35; }
.calendar-grid .cell.active{ border-color:var(--accent2); box-shadow:0 0 12px rgba(34,211,238,0.25) inset; color:var(--text); }
.cell .date-num{ font-size:12px; color:var(--muted); }
.cell .amt{ position:absolute; right:6px; bottom:6px; font-size:12px; padding:2px 6px; border-radius:999px; background:rgba(255,255,255,0.05); border:1px solid var(--border); }
.cell .amt.pos{ color:var(--success); } .cell .amt.neg{ color:var(--danger); }

.calendar-legend{ margin-top:10px; color:var(--muted); display:flex; align-items:center; gap:10px; }
.calendar-legend .dot.has-bet{ width:8px; height:8px; border-radius:50%; background:var(--accent2); display:inline-block; }
.day-summary{ margin:12px 0; display:flex; justify-content:space-between; align-items:center; }
.day-summary-title{ color:var(--muted); }
.pill{ padding:6px 10px; border-radius:999px; background:var(--panel); border:1px solid var(--border); }
.table-wrap.mini table{ font-size:13px; }

/* Tables */
.table-wrap{ background:var(--card-glass); border:1px solid var(--border); border-radius:16px; overflow:auto; }
table{ width:100%; border-collapse:collapse; font-size:14px; }
thead th{ text-align:left; color:var(--muted); position:sticky; top:0; background:var(--panel); }
th,td{ padding:10px 12px; border-top:1px solid var(--border); }
td.right{ text-align:right; }
.profit-pos{ color:var(--success); } .profit-neg{ color:var(--danger); }

/* Responsive */
@media (max-width: 1100px){ .cards{ grid-template-columns:1fr 1fr; } }
@media (max-width: 900px){
  .analytics-charts{ grid-template-columns:1fr; }
  .analytics-charts .span-2{ grid-column:auto; }
  .donut-wrap-lg{ width:320px; height:320px; }
}
@media (max-width: 780px){
  .cards{ grid-template-columns:1fr; }
  .charts{ grid-template-columns:1fr; }
  .add-form{ grid-template-columns:1fr 1fr; }
  .add-form button{ grid-column:1/-1; }
  .auth input{ min-width:150px; }
}
</style>
</head>
<body>
  <div class="bg"><div class="bg-glow"></div><div class="bg-grid"></div></div>

  <header class="topbar">
    <div class="brand">
      <div class="logo-dot"></div>
      <div class="brand-text">
        <span class="brand-name">QUANTARA</span>
        <span class="brand-tag">AI Betting Diary</span>
      </div>
    </div>
    <div class="auth">
      <input id="email" type="email" placeholder="you@example.com" />
      <input id="password" type="password" placeholder="password" />
      <button id="signup"  type="button" class="btn btn-ghost">Sign up</button>
      <button id="signin"  type="button" class="btn btn-primary">Sign in</button>
      <button id="send-link" type="button" class="btn btn-ghost">Magic link</button>
      <button id="signout" style="display:none;" type="button" class="btn btn-ghost">Sign out</button>
    </div>
  </header>

  <main class="container">
    <div class="tabs">
      <button id="tab-btn-overview"  class="tab active">Overview</button>
      <button id="tab-btn-analytics" class="tab">Analytics</button>
      <button id="tab-btn-roi"       class="tab">ROI</button>
      <button id="tab-btn-calendar"  class="tab">Calendar</button>
    </div>

    <!-- OVERVIEW -->
    <div id="tab-overview">
      <section class="cards">
        <div class="card"><div class="card-label">Bankroll</div><div class="card-value" id="bankroll">€0</div></div>
        <div class="card"><div class="card-label">Total staked</div><div class="card-value" id="staked">€0</div></div>
        <div class="card"><div class="card-label">Win rate</div><div class="card-value" id="winrate">0%</div></div>
        <div class="card settings">
          <div class="card-label">Starting Bankroll (€)</div>
          <div class="settings-row">
            <input id="bankroll-start" type="number" step="1" placeholder="10000" />
            <button id="save-bankroll" class="btn btn-primary">Save</button>
          </div>
          <div class="muted small">Stored locally on your device.</div>
        </div>
      </section>

      <section class="charts">
        <div class="chart-card">
          <div class="chart-title">Bankroll over time</div>
          <canvas id="bankrollChart" height="200"></canvas>
        </div>
      </section>

      <section class="entry">
        <form id="add-form" class="add-form">
          <div class="form-title">Add bet</div>
          <input type="date" id="f-date" required />
          <input type="text" id="f-sport" placeholder="Football" required />
          <input type="text" id="f-league" placeholder="Serie A" />
          <input type="text" id="f-market" placeholder="Over 2.5" />
          <input type="text" id="f-selection" placeholder="Lecce-Genoa" />
          <input type="number" step="0.01" id="f-odds" placeholder="1.85" required />
          <input type="number" step="1" id="f-stake" placeholder="100" required />
          <select id="f-result">
            <option value="pending">pending</option>
            <option value="win">win</option>
            <option value="loss">loss</option>
            <option value="void">void</option>
          </select>
          <button type="submit" class="btn btn-primary">Save bet</button>
        </form>
      </section>

      <section class="ledger-section">
        <div class="section-title">Ledger</div>
        <div id="month-tabs" class="month-tabs"></div>
        <div class="table-wrap">
          <table id="ledger">
            <thead>
              <tr>
                <th>Date</th><th>Sport</th><th>League</th><th>Market</th>
                <th>Selection</th><th>Odds</th><th>Stake</th><th>Result</th><th>Profit</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- ANALYTICS -->
    <div id="tab-analytics" class="hidden">
      <section class="cards">
        <div class="card"><div class="card-label">Average odds (settled)</div><div class="card-value" id="avg-odds">0.00</div></div>
        <div class="card"><div class="card-label">Max drawdown</div><div class="card-value" id="max-dd">€0</div></div>
        <div class="card"><div class="card-label">Total bets</div><div class="card-value" id="bets-total">0</div></div>
        <div class="card"><div class="card-label">Pending</div><div class="card-value" id="bets-pending">0</div></div>
      </section>

      <section class="analytics-charts">
        <div class="chart-card span-2">
          <div class="chart-title">Stake by sport</div>
          <div class="donut-wrap-lg"><canvas id="analyticsStakeChart"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Daily P&L</div>
          <canvas id="pnlBarChart" height="200"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">Odds distribution</div>
          <canvas id="oddsHistChart" height="200"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">Results breakdown</div>
          <canvas id="resultsPieChart" height="200"></canvas>
        </div>
      </section>
    </div>

    <!-- ROI -->
    <div id="tab-roi" class="hidden">
      <section class="cards">
        <div class="card"><div class="card-label">Overall ROI</div><div class="card-value" id="roi-overall">0%</div></div>
        <div class="card"><div class="card-label">Settled Bets</div><div class="card-value" id="roi-settled">0</div></div>
        <div class="card"><div class="card-label">Profit (Settled)</div><div class="card-value" id="roi-profit">€0</div></div>
        <div class="card"><div class="card-label">Stake (Settled)</div><div class="card-value" id="roi-stake">€0</div></div>
      </section>

      <section class="ledger-section">
        <div class="section-title">ROI by sport</div>
        <div class="table-wrap">
          <table id="roi-table">
            <thead>
              <tr>
                <th>Sport</th>
                <th class="right">Bets</th>
                <th class="right">Stake</th>
                <th class="right">Profit</th>
                <th class="right">ROI</th>
              </tr>
            </thead>
            <tbody id="roi-tbody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- CALENDAR -->
    <div id="tab-calendar" class="hidden">
      <section class="calendar card">
        <div class="calendar-header">
          <button id="cal-prev" class="btn btn-ghost">‹</button>
          <div id="cal-title" class="calendar-title">Month YYYY</div>
          <button id="cal-next" class="btn btn-ghost">›</button>
        </div>
        <div class="calendar-grid" id="calendar-grid"></div>

        <div class="day-summary">
          <div class="day-summary-title">Day summary</div>
          <div class="day-summary-row">
            <div id="day-selected">—</div>
            <div id="day-pnl" class="pill">€0</div>
          </div>
        </div>

        <div class="table-wrap mini">
          <table>
            <thead>
              <tr>
                <th>Sport</th><th>Market</th><th>Selection</th>
                <th class="right">Odds</th><th class="right">Stake</th><th class="right">Result</th><th class="right">P/L</th>
              </tr>
            </thead>
            <tbody id="day-tbody"></tbody>
          </table>
        </div>

        <div class="calendar-legend">
          <span class="dot has-bet"></span> dates with bets show P/L in the box
          <button id="clear-filter" class="btn btn-ghost small">Clear</button>
        </div>
      </section>
    </div>
  </main>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <!-- App (inline, module) -->
  <script type="module">
  "use strict";

  // --------- Supabase ---------
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  const SUPABASE_URL = "https://bycktplwlfrdjxghajkg.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5Y2t0cGx3bGZyZGp4Z2hhamtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNjM0MjEsImV4cCI6MjA3MDczOTQyMX0.ovDq1RLEEuOrTNeSek6-lvclXWmJfOz9DoHOv_L71iw";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // --------- State ---------
  let bankrollStart = Number(localStorage.getItem("quantara_bankroll_start") || "10000");
  let allBets = [];
  let bankrollChart, analyticsStakeChart, pnlBarChart, oddsHistChart, resultsPieChart;
  let activeMonthKey = null;      // "YYYY-MM" or null
  let filterDateISO = null;       // exact day filter (Calendar)
  let selectedCalendarISO = null; // selected day in Calendar
  let currentMonth = new Date();  // Calendar month

  // --------- Helpers ---------
  function $(id){ return document.getElementById(id); }
  function q(sel){ return document.querySelector(sel); }
  function euro(n){ return new Intl.NumberFormat("it-IT",{style:"currency",currency:"EUR"}).format(n||0); }
  function euroShort(n){ const a=Math.abs(n), s=n<0?"-":""; return a>=1000? s+"€"+(a/1000).toFixed(1)+"k" : s+"€"+a.toFixed(0); }
  function emptyNull(id){ const v=($(id).value||"").trim(); return v===""? null : v; }
  function monthName(ym){ const p=ym.split("-"); const d=new Date(Number(p[0]), Number(p[1])-1, 1); return d.toLocaleString(undefined,{month:"long", year:"numeric"}); }
  function haveChart(){ return !!window.Chart; }

  // --------- Chart helpers & plugins ---------
  function registerChartPlugins(){
    if(!haveChart()) return;
    try{ if(window.ChartDataLabels){ Chart.register(window.ChartDataLabels); } }catch(e){}
    const hoverVLinePlugin = {
      id:"hoverVLine",
      afterEvent: function(chart, args){
        const ev = (args && args.event) ? args.event : null;
        chart._inArea = (args && args.inChartArea) ? true : false;
        chart._mouseX = ev ? ev.x : null;
      },
      beforeDraw: function(chart){
        if(!chart._inArea || !chart._mouseX) return;
        const area = chart.chartArea; if(!area) return;
        const ctx = chart.ctx;
        ctx.save();
        ctx.strokeStyle = "rgba(34,211,238,0.35)";
        ctx.setLineDash([4,4]);
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(chart._mouseX, area.top);
        ctx.lineTo(chart._mouseX, area.bottom);
        ctx.stroke();
        ctx.restore();
      }
    };
    try{ Chart.register(hoverVLinePlugin); }catch(e){}
  }
  function lineGradient(ctx){
    if(!haveChart()) return "rgba(34,211,238,0.35)";
    const g = ctx.chart.ctx, area = ctx.chart.chartArea;
    if(!area) return "rgba(34,211,238,0.35)";
    const grad = g.createLinearGradient(area.left, area.top, area.right, area.bottom);
    grad.addColorStop(0,"rgba(34,211,238,0.55)");
    grad.addColorStop(1,"rgba(124,58,237,0.20)");
    return grad;
  }
  function ringGradient(ctx, idx){
    if(!haveChart()) return "#22d3ee";
    const g = ctx.chart.ctx, area = ctx.chart.chartArea;
    if(!area) return "#22d3ee";
    const palettes=[["#22d3ee","#7c3aed"],["#34d399","#0ea5e9"],["#f472b6","#8b5cf6"],["#fde047","#22d3ee"],["#f97316","#22c55e"]];
    const p=palettes[idx%palettes.length];
    const grad=g.createLinearGradient(area.left,area.top,area.right,area.bottom);
    grad.addColorStop(0,p[0]); grad.addColorStop(1,p[1]);
    return grad;
  }
  const donutShadow = {
    id:"donutShadow",
    beforeDatasetDraw:function(c){ if(!haveChart()||c.config.type!=="doughnut")return; const x=c.ctx; x.save(); x.shadowColor="rgba(0,0,0,0.35)"; x.shadowBlur=14; x.shadowOffsetY=8; },
    afterDatasetDraw:function(c){ if(!haveChart()||c.config.type!=="doughnut")return; c.ctx.restore(); }
  };

  // --------- Tabs ---------
  function setTab(tab){
    const panes={ overview:$("tab-overview"), analytics:$("tab-analytics"), roi:$("tab-roi"), calendar:$("tab-calendar") };
    const btns ={ overview:$("tab-btn-overview"), analytics:$("tab-btn-analytics"), roi:$("tab-btn-roi"), calendar:$("tab-btn-calendar") };
    Object.values(panes).forEach(function(p){ p.classList.add("hidden"); });
    Object.values(btns ).forEach(function(b){ b.classList.remove("active"); });
    panes[tab].classList.remove("hidden");
    btns[tab].classList.add("active");
    if(tab==="analytics") renderAnalytics();
    if(tab==="roi") renderROI();
    if(tab==="calendar"){ drawCalendar(); updateDayBox(); }
  }

  // --------- Startup ---------
  window.addEventListener("DOMContentLoaded", function(){
    registerChartPlugins();

    $("tab-btn-overview").addEventListener("click",function(){ setTab("overview"); });
    $("tab-btn-analytics").addEventListener("click",function(){ setTab("analytics"); });
    $("tab-btn-roi").addEventListener("click",function(){ setTab("roi"); });
    $("tab-btn-calendar").addEventListener("click",function(){ setTab("calendar"); });

    $("bankroll-start").value=String(bankrollStart);
    $("save-bankroll").addEventListener("click",function(){
      const v=Number($("bankroll-start").value||"0");
      bankrollStart=isNaN(v)?10000:v;
      localStorage.setItem("quantara_bankroll_start",String(bankrollStart));
      renderKPIs(); drawBankrollChart(); if(!$("tab-analytics").classList.contains("hidden")) renderAnalytics();
    });

    $("signup").addEventListener("click",async function(){
      const email=($("email").value||"").trim(), password=($("password").value||"").trim();
      if(!email||!password){ alert("Enter email and password"); return; }
      const out = await supabase.auth.signUp({email:email,password:password});
      if(out.error){ alert(out.error.message); return; }
      alert("Account created. Now click 'Sign in'.");
    });
    $("signin").addEventListener("click",async function(){
      const email=($("email").value||"").trim(), password=($("password").value||"").trim();
      if(!email||!password){ alert("Enter email and password"); return; }
      const out = await supabase.auth.signInWithPassword({email:email,password:password});
      if(out.error){ alert(out.error.message); return; }
      await render();
    });
    $("send-link").addEventListener("click",async function(){
      const email=($("email").value||"").trim();
      if(!email){ alert("Enter your email"); return; }
      const redirect=window.location.origin+window.location.pathname.replace(/\/?$/,"/");
      const out = await supabase.auth.signInWithOtp({email:email,options:{emailRedirectTo:redirect}});
      if(out.error){ alert(out.error.message); } else { alert("Check your email."); }
    });
    $("signout").addEventListener("click",async function(){
      await supabase.auth.signOut();
      q(".container").style.display="none";
      $("signout").style.display="none";
    });

    $("add-form").addEventListener("submit", async function(e){
      e.preventDefault();
      const u = await supabase.auth.getUser();
      const user = (u && u.data) ? u.data.user : null;
      if(!user){ alert("Please sign in first."); return; }
      const payload={
        event_date:$("f-date").value?new Date($("f-date").value).toISOString():new Date().toISOString(),
        sport:$("f-sport").value||"Football",
        league:emptyNull("f-league"),
        market:emptyNull("f-market"),
        selection:emptyNull("f-selection"),
        odds:parseFloat($("f-odds").value||"1.80"),
        stake:parseFloat($("f-stake").value||"100"),
        result:$("f-result").value,
        notes:null
      };
      const ins = await supabase.from("bets").insert(payload);
      if(ins.error){ alert("Insert failed: "+ins.error.message); return; }
      e.target.reset();
      await render();
    });

    $("cal-prev").addEventListener("click",function(){ currentMonth.setMonth(currentMonth.getMonth()-1); drawCalendar(); });
    $("cal-next").addEventListener("click",function(){ currentMonth.setMonth(currentMonth.getMonth()+1); drawCalendar(); });
    $("clear-filter").addEventListener("click",function(){ selectedCalendarISO=null; filterDateISO=null; drawCalendar(); updateDayBox(); });

    render();
  });

  // --------- Main render ---------
  async function render(){
    const sess = await supabase.auth.getSession();
    const session = (sess && sess.data) ? sess.data.session : null;
    if(!session){
      q(".container").style.display="none";
      $("signout").style.display="none";
      return;
    }
    $("signout").style.display="inline-block";
    q(".container").style.display="block";

    await supabase.from("profiles").upsert({id:session.user.id});

    const res = await supabase.from("bets_enriched").select("*").order("event_date",{ascending:true});
    if(res.error){ alert(res.error.message); return; }

    allBets=(res.data||[]).map(function(r){
      let pr = 0;
      if(r.result==="win"){ pr=(Number(r.odds)-1)*Number(r.stake); }
      else if(r.result==="loss"){ pr=-Number(r.stake); }
      return {
        id:r.id,
        date:(r.event_date||"").slice(0,10),
        sport:r.sport||"",
        league:r.league||"",
        market:r.market||"",
        selection:r.selection||"",
        odds:Number(r.odds)||0,
        stake:Number(r.stake)||0,
        result:r.result,
        profit:pr
      };
    });

    renderKPIs();
    drawBankrollChart();
    buildMonthTabs();
    renderLedger();

    if(!$("tab-analytics").classList.contains("hidden")) renderAnalytics();
    if(!$("tab-roi").classList.contains("hidden")) renderROI();
    if(!$("tab-calendar").classList.contains("hidden")){ drawCalendar(); updateDayBox(); }
  }

  // --------- KPIs ---------
  function renderKPIs(){
    const stake=allBets.reduce(function(s,b){ return s+b.stake; },0);
    const profit=allBets.reduce(function(s,b){ return s+b.profit; },0);
    const settled=allBets.filter(function(b){ return b.result!=="pending"; });
    const winRate=settled.length? (settled.filter(function(b){ return b.result==="win"; }).length/settled.length*100) : 0;
    $("bankroll").textContent=euro(bankrollStart+profit);
    $("staked").textContent=euro(stake);
    $("winrate").textContent=winRate.toFixed(1)+"%";
  }

  // --------- Ledger tabs ---------
  function buildMonthTabs(){
    const wrap=$("month-tabs"); wrap.innerHTML="";
    const groups=new Map(); // YYYY-MM -> pnl
    allBets.forEach(function(b){
      const k=b.date.slice(0,7);
      groups.set(k,(groups.get(k)||0)+b.profit);
    });
    const totalPnL=allBets.reduce(function(s,b){ return s+b.profit; },0);

    const allBtn=document.createElement("button");
    allBtn.className="month-tab"+(activeMonthKey===null?" active":"");
    allBtn.innerHTML="<span>All</span><span class=\"month-pill "+(totalPnL>=0?"pos":"neg")+"\">"+euroShort(totalPnL)+"</span>";
    allBtn.addEventListener("click",function(){ activeMonthKey=null; filterDateISO=null; renderLedger(); buildMonthTabs(); });
    wrap.appendChild(allBtn);

    Array.from(groups.keys()).sort().reverse().forEach(function(ym){
      const pnl=groups.get(ym)||0;
      const btn=document.createElement("button");
      btn.className="month-tab"+(activeMonthKey===ym?" active":"");
      btn.innerHTML="<span>"+monthName(ym)+"</span><span class=\"month-pill "+(pnl>=0?"pos":"neg")+"\">"+euroShort(pnl)+"</span>";
      btn.addEventListener("click",function(){ activeMonthKey=(activeMonthKey===ym?null:ym); filterDateISO=null; renderLedger(); buildMonthTabs(); });
      wrap.appendChild(btn);
    });
  }

  // --------- Ledger table ---------
  function renderLedger(){
    const tbody=q("#ledger tbody"); tbody.innerHTML="";
    let rows=allBets.slice();
    if(activeMonthKey){ rows=rows.filter(function(b){ return b.date.indexOf(activeMonthKey)===0; }); }
    else if(filterDateISO){ rows=rows.filter(function(b){ return b.date===filterDateISO; }); }

    rows.forEach(function(b){
      const tr=document.createElement("tr");
      const cls=b.profit>=0?"profit-pos":"profit-neg";
      tr.innerHTML =
        "<td>"+b.date+"</td><td>"+b.sport+"</td><td>"+b.league+"</td><td>"+b.market+"</td>"+
        "<td>"+b.selection+"</td><td class='right'>"+b.odds.toFixed(2)+"</td>"+
        "<td class='right'>€"+b.stake.toFixed(2)+"</td><td class='right'>"+b.result+"</td>"+
        "<td class='right "+cls+"'>€"+b.profit.toFixed(2)+"</td>";
      tbody.appendChild(tr);
    });
  }

  // --------- Charts ---------
  function drawBankrollChart(){
    if(!haveChart()) return;
    const ctx=$("bankrollChart").getContext("2d");
    const sorted=allBets.slice().sort(function(a,b){ return a.date.localeCompare(b.date); });
    let eq=bankrollStart; const labels=[]; const series=[];
    sorted.forEach(function(b){ eq+=b.profit; labels.push(b.date); series.push(Number(eq.toFixed(2))); });

    if(bankrollChart){ try{ bankrollChart.destroy(); }catch(e){} }
    bankrollChart=new Chart(ctx,{
      type:"line",
      data:{ labels:labels, datasets:[{
        label:"Bankroll (€)",
        data:series,
        borderWidth:2,
        tension:0.35,
        fill:true,
        backgroundColor:function(c){ return lineGradient(c); },
        pointRadius:3,
        pointHoverRadius:7,
        pointHitRadius:20
      }]},
      options:{
        animation:{ duration:300 },
        responsive:true,
        maintainAspectRatio:false,
        interaction:{ mode:"nearest", intersect:false },
        onHover:function(evt, elements, chart){ chart.canvas.style.cursor = (elements && elements.length) ? "pointer" : "default"; },
        plugins:{
          legend:{ display:false },
          tooltip:{
            enabled:true,
            displayColors:false,
            callbacks:{
              title:function(items){ return items[0] ? items[0].label : ""; },
              label:function(ctx){ return " "+euro(ctx.parsed.y); }
            }
          },
          datalabels:{
            align:"top", offset:6, color:"#e7eefc", font:{ weight:600, size:11 },
            formatter:function(v){ return euro(v); },
            display:function(context){
              const i=context.dataIndex;
              const last=context.dataset.data.length-1;
              return i===last || context.active;
            }
          }
        },
        scales:{
          x:{ ticks:{ color:"#93a0b7" }, grid:{ color:"rgba(147,160,183,0.1)" } },
          y:{ ticks:{ color:"#93a0b7" }, grid:{ color:"rgba(147,160,183,0.1)" } }
        }
      }
    });
  }

  function renderAnalytics(){
    const settled=allBets.filter(function(b){ return b.result!=="pending"; });
    const avgOdds = settled.length ? settled.reduce(function(s,b){return s+b.odds;},0)/settled.length : 0;
    $("avg-odds").textContent=avgOdds.toFixed(2);
    $("max-dd").textContent=euro(computeMaxDrawdown());
    $("bets-total").textContent=String(allBets.length);
    $("bets-pending").textContent=String(allBets.filter(function(b){ return b.result==="pending"; }).length);

    drawAnalyticsStakeChart(); drawPnlBarChart(); drawOddsHistogram(); drawResultsPie();
  }
  function drawAnalyticsStakeChart(){
    if(!haveChart()) return;
    const wrap=q(".donut-wrap-lg"), canvas=$("analyticsStakeChart"), ctx=canvas.getContext("2d");
    canvas.width=wrap.clientWidth; canvas.height=wrap.clientHeight;
    const bySport={}; allBets.forEach(function(b){ bySport[b.sport]=(bySport[b.sport]||0)+b.stake; });
    const labels=Object.keys(bySport), values=Object.values(bySport);
    if(analyticsStakeChart){ try{ analyticsStakeChart.destroy(); }catch(e){} }
    analyticsStakeChart=new Chart(ctx,{ type:"doughnut", data:{ labels:labels, datasets:[{ data:values, borderWidth:1, borderColor:"#0d1524", backgroundColor:function(c){ return ringGradient(c,c.dataIndex); }, hoverOffset:6 }] }, options:{ responsive:false, maintainAspectRatio:false, plugins:{ legend:{ labels:{ color:"#e7eefc"} } }, cutout:"76%", radius:"70%" }, plugins:[donutShadow] });
  }
  function drawPnlBarChart(){
    if(!haveChart()) return;
    const ctx=$("pnlBarChart").getContext("2d");
    const daily=groupByDateSum(allBets.map(function(b){ return {date:b.date, pnl:b.profit}; }));
    const labels=daily.map(function(d){return d.date;});
    const values=daily.map(function(d){return Number(d.pnl.toFixed(2));});
    if(pnlBarChart){ try{ pnlBarChart.destroy(); }catch(e){} }
    pnlBarChart=new Chart(ctx,{ type:"bar", data:{labels:labels, datasets:[{label:"P&L (€)", data:values}]}, options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ x:{ticks:{color:"#93a0b7"}, grid:{display:false}}, y:{ticks:{color:"#93a0b7"}, grid:{color:"rgba(147,160,183,0.1)"}} } });
  }
  function drawOddsHistogram(){
    if(!haveChart()) return;
    const ctx=$("oddsHistChart").getContext("2d");
    const bins=[[1,1.5],[1.5,2],[2,2.5],[2.5,3],[3,10]];
    const labels=["1–1.5","1.5–2","2–2.5","2.5–3","3+"];
    const counts=bins.map(function(r){ const lo=r[0], hi=r[1]; return allBets.filter(function(b){ return b.odds>=lo && b.odds<(hi||1e9); }).length; });
    if(oddsHistChart){ try{ oddsHistChart.destroy(); }catch(e){} }
    oddsHistChart=new Chart(ctx,{ type:"bar", data:{labels:labels, datasets:[{label:"Bets", data:counts}]}, options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ x:{ticks:{color:"#93a0b7"}, grid:{display:false}}, y:{ticks:{color:"#93a0b7"}, grid:{color:"rgba(147,160,183,0.1)"}, beginAtZero:true, precision:0} } });
  }
  function drawResultsPie(){
    if(!haveChart()) return;
    const ctx=$("resultsPieChart").getContext("2d");
    const counts={win:0,loss:0,pending:0,void:0}; allBets.forEach(function(b){ counts[b.result]=(counts[b.result]||0)+1; });
    if(resultsPieChart){ try{ resultsPieChart.destroy(); }catch(e){} }
    resultsPieChart=new Chart(ctx,{ type:"doughnut", data:{ labels:["win","loss","pending","void"], datasets:[{ data:[counts.win,counts.loss,counts.pending,counts.void], backgroundColor:function(c){ return ringGradient(c,c.dataIndex); }, borderWidth:1, borderColor:"#0d1524" }]}, options:{ plugins:{legend:{labels:{color:"#e7eefc"}}}, cutout:"65%" }, plugins:[donutShadow] });
  }

  // --------- Calendar ---------
  function drawCalendar(){
    const y=currentMonth.getFullYear(), m=currentMonth.getMonth();
    $("cal-title").textContent=currentMonth.toLocaleString(undefined,{month:"long", year:"numeric"});

    const sums=new Map(), counts=new Map();
    allBets.forEach(function(b){ sums.set(b.date,(sums.get(b.date)||0)+b.profit); counts.set(b.date,(counts.get(b.date)||0)+1); });

    const first=new Date(y,m,1);
    const start=new Date(first); start.setDate(first.getDate()-first.getDay());
    const grid=$("calendar-grid"); grid.innerHTML="";

    for(let i=0;i<42;i++){
      const d=new Date(start); d.setDate(start.getDate()+i); const iso=d.toISOString().slice(0,10);
      const pnl=sums.get(iso)||0; const has=counts.has(iso);

      const cell=document.createElement("div");
      cell.className="cell"+(d.getMonth()!==m?" out":"")+(selectedCalendarISO===iso?" active":"");
      cell.title = has ? (iso+" — bets: "+counts.get(iso)+", P/L: "+euro(pnl)) : (iso+" — no bets");
      cell.innerHTML = "<div class='date-num'>"+d.getDate()+"</div>"+(has?("<div class='amt "+(pnl>0?"pos":(pnl<0?"neg":""))+"'>"+euroShort(pnl)+"</div>"):"");
      (function(isoCopy){
        cell.addEventListener("click",function(){ selectedCalendarISO = (selectedCalendarISO===isoCopy? null : isoCopy); filterDateISO=selectedCalendarISO; drawCalendar(); updateDayBox(); });
      })(iso);
      grid.appendChild(cell);
    }
  }
  function updateDayBox(){
    const label=$("day-selected"), pill=$("day-pnl"), tbody=$("day-tbody"); tbody.innerHTML="";
    if(!selectedCalendarISO){ label.textContent="—"; pill.textContent="€0"; pill.classList.remove("profit-pos"); pill.classList.remove("profit-neg"); return; }
    label.textContent=selectedCalendarISO;
    const rows=allBets.filter(function(b){ return b.date===selectedCalendarISO; });
    const dayPnl=rows.reduce(function(s,b){ return s+b.profit; },0);
    pill.textContent=euro(dayPnl);
    pill.classList.remove("profit-pos"); pill.classList.remove("profit-neg");
    pill.classList.add(dayPnl>=0?"profit-pos":"profit-neg");
    rows.forEach(function(b){
      const tr=document.createElement("tr");
      const cls=b.profit>=0?"profit-pos":"profit-neg";
      tr.innerHTML="<td>"+b.sport+"</td><td>"+b.market+"</td><td>"+b.selection+"</td><td class='right'>"+b.odds.toFixed(2)+"</td><td class='right'>€"+b.stake.toFixed(2)+"</td><td class='right'>"+b.result+"</td><td class='right "+cls+"'>€"+b.profit.toFixed(2)+"</td>";
      tbody.appendChild(tr);
    });
  }

  // --------- ROI ---------
  function renderROI(){
    const settled=allBets.filter(function(b){ return b.result!=="pending" && b.result!=="void"; });
    const staked=settled.reduce(function(s,b){ return s+b.stake; },0);
    const profit=settled.reduce(function(s,b){ return s+b.profit; },0);
    const roi=staked? (profit/staked)*100 : 0;

    $("roi-overall").textContent = roi.toFixed(2) + "%";
    $("roi-settled").textContent = String(settled.length);
    $("roi-profit").textContent  = euro(profit);
    $("roi-stake").textContent   = euro(staked);

    const bySport={};
    settled.forEach(function(b){
      if(!bySport[b.sport]) bySport[b.sport]={bets:0, stake:0, profit:0};
      bySport[b.sport].bets++; bySport[b.sport].stake+=b.stake; bySport[b.sport].profit+=b.profit;
    });

    const tbody=$("roi-tbody"); tbody.innerHTML="";
    Object.keys(bySport).forEach(function(sport){
      const agg=bySport[sport];
      const roiPct=agg.stake? (agg.profit/agg.stake)*100 : 0;
      const tr=document.createElement("tr");
      tr.innerHTML="<td>"+sport+"</td><td class='right'>"+agg.bets+"</td><td class='right'>"+euro(agg.stake)+"</td><td class='right "+(agg.profit>=0?"profit-pos":"profit-neg")+"'>"+euro(agg.profit)+"</td><td class='right "+(roiPct>=0?"profit-pos":"profit-neg")+"'>"+roiPct.toFixed(2)+"%</td>";
      tbody.appendChild(tr);
    });
  }

  // --------- Utils ---------
  function groupByDateSum(items){
    const map=new Map();
    items.forEach(function(it){ map.set(it.date,(map.get(it.date)||0)+it.pnl); });
    return Array.from(map.entries()).sort(function(a,b){ return a[0].localeCompare(b[0]); }).map(function(e){ return {date:e[0], pnl:e[1]}; });
  }
  function computeMaxDrawdown(){
    const sorted=allBets.slice().sort(function(a,b){ return a.date.localeCompare(b.date); });
    let equity=bankrollStart, peak=bankrollStart, maxDD=0;
    sorted.forEach(function(b){
      equity+=b.profit;
      if(equity>peak) peak=equity;
      const dd=peak-equity;
      if(dd>maxDD) maxDD=dd;
    });
    return maxDD;
  }
  </script>
</body>
</html>
