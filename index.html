<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quantara — AI Betting Diary</title>
  <link rel="stylesheet" href="./styles.css?v=14" />
  <!-- Chart.js v4 (UMD) -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <!-- Supabase JS v2 (UMD) -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <span class="logo">Q₳</span>
      <div class="titles">
        <h1>Quantara</h1>
        <small class="subtitle">AI Betting Diary</small>
      </div>
    </div>
    <div class="spacer"></div>
    <div class="account">
      <span id="activeBankrollTag" class="tag">No bankroll</span>
      <button id="btnOpenAuth" class="btn ghost">Sign in</button>
      <button id="btnLogout" class="btn danger hidden">Logout</button>
    </div>
  </header>

  <nav class="tabs">
    <button class="tab active" data-tab="home">Home</button>
    <button class="tab" data-tab="overview">Overview</button>
    <button class="tab" data-tab="analytics">Analytics</button>
    <button class="tab" data-tab="roi">ROI</button>
    <button class="tab" data-tab="calendar">Calendar</button>
    <button class="tab" data-tab="tools">Tools</button>
    <button class="tab" data-tab="settings">Settings</button>
  </nav>

  <main>
    <!-- HOME -->
    <section id="home" class="view active">
      <div class="grid two">
        <div class="card">
          <div class="card-head">
            <h2>Bankrolls</h2>
            <div class="row gap">
              <button id="btnAddBankroll" class="btn">+ Add</button>
              <button id="btnSwitchBankroll" class="btn ghost">Switch</button>
            </div>
          </div>
          <div id="bankrollList" class="list"></div>
        </div>

        <div class="card">
          <div class="card-head">
            <h2>Quick Add Bet</h2>
          </div>
          <form id="quickBetForm" class="form grid two">
            <label> Date
              <input type="date" name="date" required />
            </label>
            <label> Sport
              <input type="text" name="sport" placeholder="Football" />
            </label>
            <label> Market
              <input type="text" name="market" placeholder="1X2 / O2.5 / BTTS" />
            </label>
            <label> Selection
              <input type="text" name="selection" placeholder="Home / Over 2.5 / Yes" />
            </label>
            <label> Odds
              <input type="number" name="odds" step="0.0001" min="1.01" required />
            </label>
            <label> Stake
              <input type="number" name="stake" step="0.01" min="0" required />
            </label>
            <label> Result
              <select name="result">
                <option value="open">Open</option>
                <option value="win">Win</option>
                <option value="lose">Lose</option>
                <option value="void">Void</option>
              </select>
            </label>
            <label> Notes
              <input type="text" name="notes" placeholder="Optional" />
            </label>
            <div class="row end col-span-2">
              <button class="btn" type="submit">Add Bet</button>
            </div>
          </form>
        </div>
      </div>

      <div class="grid two">
        <div class="card">
          <div class="card-head"><h2>Today & Open</h2></div>
          <div id="homeOpenBets" class="table-wrap"></div>
        </div>
        <div class="card">
          <div class="card-head">
            <h2>Bankroll Snapshot</h2>
          </div>
          <canvas id="homeSnapshotChart" height="120"></canvas>
        </div>
      </div>
    </section>

    <!-- OVERVIEW -->
    <section id="overview" class="view">
      <div class="card">
        <div class="card-head">
          <h2>Bets</h2>
          <div class="row gap">
            <input id="filterDateFrom" type="date" />
            <input id="filterDateTo" type="date" />
            <select id="filterResult">
              <option value="all">All</option>
              <option value="open">Open</option>
              <option value="win">Win</option>
              <option value="lose">Lose</option>
              <option value="void">Void</option>
            </select>
            <button id="btnApplyFilter" class="btn">Filter</button>
          </div>
        </div>
        <div id="betsTable" class="table-wrap"></div>
      </div>
    </section>

    <!-- ANALYTICS -->
    <section id="analytics" class="view">
      <div class="grid two">
        <div class="card">
          <div class="card-head"><h2>Monthly P&L</h2></div>
          <canvas id="monthlyPnLChart" height="160"></canvas>
        </div>
        <div class="card">
          <div class="card-head"><h2>Cumulative Equity</h2></div>
          <canvas id="equityChart" height="160"></canvas>
        </div>
      </div>
    </section>

    <!-- ROI -->
    <section id="roi" class="view">
      <div class="grid two">
        <div class="card">
          <div class="card-head"><h2>ROI by Bankroll</h2></div>
          <canvas id="roiByBankrollChart" height="160"></canvas>
        </div>
        <div class="card">
          <div class="card-head"><h2>KPIs</h2></div>
          <div id="kpiGrid" class="kpis"></div>
        </div>
      </div>
    </section>

    <!-- CALENDAR -->
    <section id="calendar" class="view">
      <div class="card">
        <div class="card-head">
          <h2>Bet Calendar</h2>
          <div class="row gap">
            <button id="calPrev" class="btn ghost">‹ Prev</button>
            <span id="calTitle" class="tag"></span>
            <button id="calNext" class="btn ghost">Next ›</button>
          </div>
        </div>
        <div id="calendarGrid" class="calendar"></div>
      </div>
    </section>

    <!-- TOOLS -->
    <section id="tools" class="view">
      <div class="grid three">
        <!-- Risk -->
        <div class="card">
          <div class="card-head"><h2>Risk / Kelly</h2></div>
          <form id="riskForm" class="form">
            <label>Bankroll <input type="number" name="bankroll" step="0.01" min="0" /></label>
            <label>Odds (decimal) <input type="number" name="odds" step="0.0001" min="1.01" required /></label>
            <label>Win Prob. (0–1) <input type="number" name="p" step="0.0001" min="0" max="1" required /></label>
            <div class="row gap">
              <button class="btn" type="submit">Calculate</button>
              <button class="btn ghost" type="button" id="riskUseBankroll">Use Active Bankroll</button>
            </div>
          </form>
          <div id="riskOutput" class="muted"></div>
          <canvas id="riskChart" height="110"></canvas>
        </div>

        <!-- Poisson -->
        <div class="card">
          <div class="card-head"><h2>Poisson (Football)</h2></div>
          <form id="poissonForm" class="form grid two">
            <label>Home xG <input type="number" name="lambdaHome" step="0.01" min="0" required /></label>
            <label>Away xG <input type="number" name="lambdaAway" step="0.01" min="0" required /></label>
            <div class="row end col-span-2"><button class="btn" type="submit">Compute</button></div>
          </form>
          <div id="poissonOutput" class="muted"></div>
          <canvas id="poissonChart" height="110"></canvas>
        </div>

        <!-- Masaniello -->
        <div class="card">
          <div class="card-head">
            <h2>Masaniello</h2>
            <div class="row gap">
              <button id="btnSaveMasaniello" class="btn ghost">Save System</button>
              <button id="btnLoadMasaniello" class="btn ghost">Load</button>
            </div>
          </div>
          <form id="masForm" class="form grid three">
            <label class="col-span-2">System Name <input type="text" name="name" placeholder="e.g., Serie A Weekend Plan" /></label>
            <label># Bets (N) <input type="number" name="n" min="1" step="1" required /></label>
            <label>Expected Wins (K) <input type="number" name="k" min="0" step="1" required /></label>
            <label>Target Profit (€) <input type="number" name="target" step="0.01" min="0" required /></label>
            <label class="col-span-2">Starting Bankroll (€) <input type="number" name="bankroll" step="0.01" min="0" required /></label>
            <label>Avg. Odds (est.) <input type="number" name="avgOdds" step="0.0001" min="1.01" required /></label>
            <div class="row end col-span-3"><button class="btn" type="submit">Build</button></div>
          </form>
          <div id="masTable" class="table-wrap"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-head"><h2>Saved Masaniello Systems</h2></div>
        <div id="masSavedList" class="list"></div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="view">
      <div class="grid two">
        <div class="card">
          <div class="card-head"><h2>Account</h2></div>
          <div id="accountBox" class="muted">Not signed in.</div>
          <div class="row gap">
            <button id="btnSchemaHelp" class="btn ghost">Schema Help</button>
          </div>
        </div>
        <div class="card">
          <div class="card-head"><h2>Data</h2></div>
          <div class="row gap">
            <button id="btnExport" class="btn">Export JSON</button>
            <button id="btnImport" class="btn ghost">Import JSON</button>
            <input id="importFile" type="file" accept="application/json" class="hidden" />
          </div>
        </div>
      </div>
      <div class="muted" style="margin-top:12px;">App v<span id="appVersion">14</span></div>
    </section>
  </main>

  <!-- EDIT BET MODAL -->
  <dialog id="editBetModal" class="modal">
    <form method="dialog" class="card form">
      <div class="card-head">
        <h3>Edit Bet</h3>
        <button value="cancel" class="btn ghost">✕</button>
      </div>
      <input type="hidden" name="id" />
      <label>Date <input type="date" name="date" required /></label>
      <label>Sport <input type="text" name="sport" /></label>
      <label>Market <input type="text" name="market" /></label>
      <label>Selection <input type="text" name="selection" /></label>
      <label>Odds <input type="number" name="odds" step="0.0001" min="1.01" required /></label>
      <label>Stake <input type="number" name="stake" step="0.01" min="0" required /></label>
      <label>Result
        <select name="result">
          <option value="open">Open</option>
          <option value="win">Win</option>
          <option value="lose">Lose</option>
          <option value="void">Void</option>
        </select>
      </label>
      <label>Notes <input type="text" name="notes" /></label>
      <div class="row end">
        <button class="btn danger" id="btnDeleteBet" type="button">Delete</button>
        <button class="btn" value="default">Save</button>
      </div>
    </form>
  </dialog>

  <!-- AUTH MODAL -->
  <dialog id="authModal" class="modal">
    <form method="dialog" class="card form">
      <div class="card-head">
        <h3>Sign in</h3>
        <button value="cancel" class="btn ghost">✕</button>
      </div>
      <label>Email for Magic Link
        <input type="email" id="authEmail" placeholder="you@example.com" />
      </label>
      <div class="row gap">
        <button id="btnSendMagicLink" class="btn" type="button">Send Link</button>
        <button id="btnAnon" class="btn ghost" type="button">Continue Anonymously</button>
      </div>
      <div id="authHelp" class="muted"></div>
    </form>
  </dialog>

  <!-- SCHEMA HELP MODAL -->
  <dialog id="schemaModal" class="modal">
    <form method="dialog" class="card form">
      <div class="card-head">
        <h3>Supabase Schema (Run once)</h3>
        <button value="cancel" class="btn ghost">✕</button>
      </div>
<pre class="code">
-- Create tables
create table if not exists profiles(
  id uuid primary key references auth.users(id),
  email text,
  created_at timestamp with time zone default now()
);

create table if not exists bankrolls(
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users(id) not null,
  name text not null,
  currency text default 'EUR',
  starting_balance numeric not null,
  current_balance numeric not null,
  created_at timestamp with time zone default now()
);

create table if not exists bets(
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users(id) not null,
  bankroll_id uuid references bankrolls(id),
  date date not null,
  sport text,
  league text,
  market text,
  selection text,
  odds numeric not null,
  stake numeric not null,
  result text check (result in ('open','win','lose','void')) default 'open',
  profit numeric default 0,
  notes text,
  created_at timestamp with time zone default now()
);

create table if not exists masaniello_systems(
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users(id) not null,
  bankroll_id uuid references bankrolls(id),
  name text not null,
  n_bets int not null,
  expected_wins int not null,
  target_profit numeric not null,
  starting_bankroll numeric not null,
  avg_odds numeric not null,
  state jsonb default '{}'::jsonb,
  created_at timestamp with time zone default now()
);

-- RLS
alter table profiles enable row level security;
alter table bankrolls enable row level security;
alter table bets enable row level security;
alter table masaniello_systems enable row level security;

create policy "Users manage own profile" on profiles
  for all using (auth.uid() = id);

create policy "Users manage own bankrolls" on bankrolls
  for all using (auth.uid() = user_id);

create policy "Users manage own bets" on bets
  for all using (auth.uid() = user_id);

create policy "Users manage own masaniello" on masaniello_systems
  for all using (auth.uid() = user_id);
</pre>
      <div class="muted">SQL → Supabase &gt; SQL Editor → Run. Then reload.</div>
    </form>
  </dialog>

  <!-- APP -->
  <script type="module" src="./app.js?v=14"></script>
</body>
</html>
